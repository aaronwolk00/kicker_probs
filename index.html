<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NFL FG Probability — Pro Coach UI (v2)</title>
<style>
  :root{
    --bg:#0b0f14;--card:#10161f;--muted:#9fb0c3;--text:#e9f0f7;--acc:#3da9fc;--accent-2:#7ae582;--warn:#ffcc66;--border:#233041;--grid:#1f2a38;
    --focus: 0 0 0 3px #264b9333, 0 0 0 1px var(--acc);
  }
  html,body{height:100%}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial;background:var(--bg);color:var(--text)}
  a{color:var(--acc)}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;gap:12px;align-items:center}
  h1{font-size:24px;margin:0 0 4px 0}
  .tagline{color:var(--muted);font-size:13px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:16px}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
  @media (max-width: 980px){.grid{grid-template-columns:1fr}}
  label{font-size:13px;color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr 120px;gap:8px;align-items:center;margin:10px 0}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center;margin:10px 0}
  .controls input[type="number"], .controls select, .controls input[type="text"]{background:#0e141c;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;width:100%}
  .controls input[type="range"]{width:100%}
  .muted{color:var(--muted);font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#0f141b;border:1px solid var(--border);color:var(--muted);font-size:12px}
  .kmeta{font-size:12px;color:var(--muted);margin-top:4px}
  .btn{background:#0f141b;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn:hover{border-color:#37506b}
  .btn.primary{background:linear-gradient(180deg,#1a2634,#111823);border-color:#2b415a}
  .btn.ghost{background:transparent}
  .btnbar{display:flex;flex-wrap:wrap;gap:8px}
  .statbar{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media (max-width: 680px){.statbar{grid-template-columns:repeat(2,1fr)}}
  .stat{background:#0f141b;border:1px solid var(--border);border-radius:12px;padding:12px}
  .stat h3{margin:0 0 2px 0;font-size:15px;color:var(--muted)}
  .stat .val{font-size:20px;font-weight:700}
  .svgbox{width:100%;height:280px;background:#0f141b;border:1px solid var(--border);border-radius:14px}
  .warn{color:var(--warn)}
  .toggle{display:flex;gap:8px;align-items:center}
  .right{display:flex;gap:12px;align-items:center}
  .divider{height:1px;background:var(--border);margin:14px 0}
  .footer{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0e141c;border:1px solid var(--border);border-radius:6px;padding:2px 6px;font-size:12px;color:var(--muted)}
  .help{border-left:3px solid #25415d;padding-left:12px}
  .badge{display:inline-block;background:#142233;border:1px solid #22374d;padding:2px 8px;border-radius:999px;color:#a6c1da;font-size:12px}
  .filezone{display:flex;flex-wrap:wrap;gap:8px}
  .filezone input[type="file"]{display:block}
  .switch{position:relative;display:inline-block;width:44px;height:24px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;inset:0;background:#16212e;border:1px solid var(--border);transition:.2s;border-radius:999px}
  .slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:50%;transform:translateY(-50%);background:#2c3a4e;border-radius:50%;transition:.2s}
  .switch input:checked + .slider{background:#152438;border-color:#33557a}
  .switch input:checked + .slider:before{transform:translate(20px,-50%)}
  .toast{position:fixed;right:16px;bottom:16px;background:#0f141b;border:1px solid var(--border);padding:10px 12px;border-radius:10px;color:var(--text);box-shadow:0 6px 20px rgba(0,0,0,.35);opacity:0;transform:translateY(6px);transition:.2s}
  .toast.show{opacity:1;transform:translateY(0)}
  .vis-legend{display:flex;gap:12px;align-items:center;margin-top:8px}
  .legend-item{display:flex;gap:6px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.make{background:var(--acc)}
  .dot.ci{background:rgba(61,169,252,.25);border:1px solid rgba(61,169,252,.5)}
  .dot.attempt{background:var(--accent-2)}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .hint{color:#a6c1da;font-size:12px}
  .kbd-row{display:flex;gap:8px;align-items:center}
  .subtle{opacity:.85}
  .danger{color:#ff8e8e}
  /* focus */
  .btn:focus, select:focus, input:focus{outline:none;box-shadow:var(--focus)}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="badge">Coach View</div>
      <div>
        <h1>Field Goal Probability — Coupled</h1>
        <div class="tagline">Bilinear Make% (Temp×Wind) + recency-weighted kicker deltas + context-driven Attempt% with coupling.</div>
      </div>
    </div>
    <div class="right">
      <label class="toggle" title="Toggle compact labels on chart">
        <span class="muted">Axes</span>
        <label class="switch"><input id="toggleAxes" type="checkbox" checked/><span class="slider"></span></label>
      </label>
      <button class="btn" id="btnShare" title="Copy a permalink with current settings">Share</button>
      <button class="btn" id="btnReset" title="Reset inputs to defaults">Reset</button>
    </div>
  </div>

  <div class="grid">
    <!-- Controls -->
    <div class="card controls" aria-label="Inputs">
      <div class="btnbar" style="margin-bottom:6px">
        <button class="btn ghost" data-preset-temp="20">Cold 20°F</button>
        <button class="btn ghost" data-preset-temp="50">Mild 50°F</button>
        <button class="btn ghost" data-preset-temp="70">Warm 70°F</button>
        <button class="btn ghost" data-preset-temp="90">Hot 90°F</button>
        <button class="btn ghost" data-preset-wind="0">Calm</button>
        <button class="btn ghost" data-preset-wind="5">Breeze</button>
        <button class="btn ghost" data-preset-wind="15">Windy</button>
      </div>
      <div class="row">
        <label for="distance">Distance (yards)</label>
        <input id="distance" type="range" min="18" max="68" step="1" value="61"/>
      </div>
      <div class="row">
        <label for="uiDist" class="sr-only">Distance numeric</label>
        <input id="uiDist" type="number" min="18" max="68" step="1" value="61"/>
        <span class="muted">Use <span class="kbd">↑/↓</span> to nudge</span>
      </div>

      <div class="row-2">
        <div>
          <label for="env">Environment</label>
          <select id="env">
            <option value="indoor">Indoor</option>
            <option value="outdoor" selected>Outdoor</option>
          </select>
        </div>
        <div class="hint">Roof listed as “outdoors” → Outdoor; else Indoor.</div>
      </div>

      <div class="row-2">
        <div>
          <label for="temp">Temperature (°F)</label>
          <input id="temp" type="number" value="65" step="1"/>
        </div>
        <div>
          <label for="wind">Wind (mph)</label>
          <input id="wind" type="number" value="5" step="1"/>
          <div class="hint">Indoor forces 0</div>
        </div>
      </div>

      <div class="row-2">
        <div>
          <label for="kickerSearch">Kicker (search)</label>
          <input id="kickerSearch" type="text" placeholder="Start typing a name…" autocomplete="off"/>
        </div>
        <div>
          <label for="kicker">Kicker</label>
          <select id="kicker"><option value="">— none —</option></select>
        </div>
      </div>

      <div class="row-2">
        <div>
          <label for="scoreBin">Score</label>
          <select id="scoreBin">
            <option value="trail">Trailing (≤ −3)</option>
            <option value="close" selected>Close (−2..+2)</option>
            <option value="lead">Leading (≥ +3)</option>
          </select>
        </div>
        <div>
          <label for="timeBin">Time (half)</label>
          <select id="timeBin">
            <option value="early">Early (≈20:00)</option>
            <option value="mid">Mid (≈10:00)</option>
            <option value="late" selected>Late (≈2:00)</option>
          </select>
        </div>
      </div>

      <div class="row-2">
        <div>
          <label for="ytgBin">Yards to go</label>
          <select id="ytgBin">
            <option value="short">Short (≤2)</option>
            <option value="med" selected>Medium (3–6)</option>
            <option value="long">Long (≥7)</option>
          </select>
        </div>
        <div>
          <label for="band">Confidence band</label>
          <select id="band">
            <option value="80" selected>80% (p10–p90)</option>
            <option value="68">~68%</option>
            <option value="90">90%</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <div class="muted help">
        Make model: LGBM (monotone distance) · bagged · isotonic · bilinear (Temp×Wind).<br/>
        Kicker: recency-weighted Bayesian deltas by distance band (weaker prior 60+).<br/>
        Attempt model: league context grid + <em>coupling</em> ⇒ Attempt% rises with kicker Make% advantage.
      </div>

      <div id="kmeta" class="kmeta"></div>

      <div class="divider"></div>

      <div>
        <div class="muted" id="loadMsg"></div>
        <div class="filezone" id="fallbackUpload" style="display:none">
          <label class="pill">Load make grid <input type="file" id="fileGrid" accept=".json"/></label>
          <label class="pill">Load kicker banded JSON <input type="file" id="fileKickers" accept=".json"/></label>
          <label class="pill">Load attempt grid <input type="file" id="fileAttempt" accept=".json"/></label>
          <label class="pill">Load attempt sensitivity <input type="file" id="fileSens" accept=".json"/></label>
          <button id="btnUseUploads" class="btn">Use uploaded files</button>
        </div>
      </div>
    </div>

    <!-- Output -->
    <div class="card" aria-live="polite">
      <div class="statbar" id="statbar">
        <div class="stat"><h3>Make | Attempt</h3><div class="val" id="statMake">—</div><div class="muted" id="statMakeCI">—</div></div>
        <div class="stat"><h3>Attempt % (base)</h3><div class="val" id="statAttemptBase">—</div><div class="muted" id="statAttemptBaseCI">—</div></div>
        <div class="stat"><h3>Attempt % (kicker-adjusted)</h3><div class="val" id="statAttemptAdj">—</div><div class="muted">Coupled</div></div>
        <div class="stat"><h3>Overall Make %</h3><div class="val" id="statOverall">—</div><div class="muted">= AttemptAdj × Make</div></div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0">Distance Profile</h3>
      <svg id="chart" class="svgbox" viewBox="0 0 880 280" preserveAspectRatio="none" role="img" aria-label="Make% curve with confidence band and attempt% overlay"></svg>
      <div class="vis-legend">
        <div class="legend-item"><span class="dot make"></span><span class="muted">Make%</span></div>
        <div class="legend-item"><span class="dot ci"></span><span class="muted">CI</span></div>
        <div class="legend-item"><span class="dot attempt"></span><span class="muted">Attempt% (context)</span></div>
      </div>

      <div class="btnbar" style="margin-top:10px">
        <button id="btnCSV" class="btn">Download CSV</button>
        <button id="btnPNG" class="btn">Download PNG</button>
        <label class="toggle" title="Show attempt% curve across distance">
          <span class="muted">Show Attempt Curve</span>
          <label class="switch"><input id="toggleAttempt" type="checkbox" checked/><span class="slider"></span></label>
        </label>
      </div>

      <div id="details" class="muted" style="margin-top:10px">—</div>
    </div>
  </div>

  <div class="card footer">
    <div class="muted">Tip: Press <span class="kbd">↑</span>/<span class="kbd">↓</span> to adjust distance; <span class="kbd">⌘/Ctrl</span> + <span class="kbd">C</span> on the chart to copy a PNG.</div>
    <div class="muted subtle">v2 UI • Built for rapid what‑ifs & decision clarity.</div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Embedded tiny demo data (used only if fetch/uploads fail) -->
<script id="demo_grid" type="application/json">{
  "meta":{"temps":[20,50,80],"winds":[0,10,20]},
  "grid":[
    {"indoor_outdoor":"indoor","temp_F":20,"wind_mph":0,"distance":18,"prob_mean":0.99,"prob_p10":0.97,"prob_p90":0.995},
    {"indoor_outdoor":"indoor","temp_F":50,"wind_mph":0,"distance":18,"prob_mean":0.99,"prob_p10":0.97,"prob_p90":0.995},
    {"indoor_outdoor":"indoor","temp_F":80,"wind_mph":0,"distance":18,"prob_mean":0.99,"prob_p10":0.97,"prob_p90":0.995},
    {"indoor_outdoor":"outdoor","temp_F":50,"wind_mph":10,"distance":18,"prob_mean":0.99,"prob_p10":0.97,"prob_p90":0.995},
    {"indoor_outdoor":"outdoor","temp_F":20,"wind_mph":20,"distance":18,"prob_mean":0.985,"prob_p10":0.96,"prob_p90":0.994},
    {"indoor_outdoor":"outdoor","temp_F":50,"wind_mph":0,"distance":40,"prob_mean":0.88,"prob_p10":0.82,"prob_p90":0.93},
    {"indoor_outdoor":"outdoor","temp_F":50,"wind_mph":10,"distance":40,"prob_mean":0.84,"prob_p10":0.78,"prob_p90":0.90},
    {"indoor_outdoor":"outdoor","temp_F":80,"wind_mph":20,"distance":40,"prob_mean":0.79,"prob_p10":0.72,"prob_p90":0.86},
    {"indoor_outdoor":"outdoor","temp_F":50,"wind_mph":0,"distance":55,"prob_mean":0.60,"prob_p10":0.50,"prob_p90":0.69},
    {"indoor_outdoor":"outdoor","temp_F":50,"wind_mph":10,"distance":55,"prob_mean":0.54,"prob_p10":0.44,"prob_p90":0.63},
    {"indoor_outdoor":"outdoor","temp_F":50,"wind_mph":20,"distance":55,"prob_mean":0.47,"prob_p10":0.37,"prob_p90":0.57},
    {"indoor_outdoor":"outdoor","temp_F":50,"wind_mph":10,"distance":65,"prob_mean":0.28,"prob_p10":0.20,"prob_p90":0.36},
    {"indoor_outdoor":"outdoor","temp_F":20,"wind_mph":20,"distance":65,"prob_mean":0.20,"prob_p10":0.13,"prob_p90":0.28}
  ]
}</script>
<script id="demo_kickers" type="application/json">[
  {"kicker_id":"k1","kicker_name":"A. Accurate","attempts_eff":120.2,"bands":{"short":{"delta_logit":0.05,"se":0.02},"mid":{"delta_logit":0.04,"se":0.03},"long":{"delta_logit":0.03,"se":0.05},"xlong":{"delta_logit":0.01,"se":0.08}}},
  {"kicker_id":"k2","kicker_name":"B. Boomer","attempts_eff":90.4,"bands":{"short":{"delta_logit":-0.02,"se":0.03},"mid":{"delta_logit":0.00,"se":0.04},"long":{"delta_logit":0.05,"se":0.05},"xlong":{"delta_logit":0.07,"se":0.06}}}
]</script>
<script id="demo_attempt" type="application/json">{
  "grid":[
    {"indoor_outdoor":"outdoor","score_bin":"close","time_bin":"late","ytg_bin":"med","distance":40,"prob_attempt_mean":0.78,"prob_attempt_p10":0.60,"prob_attempt_p90":0.90},
    {"indoor_outdoor":"outdoor","score_bin":"close","time_bin":"late","ytg_bin":"med","distance":55,"prob_attempt_mean":0.62,"prob_attempt_p10":0.42,"prob_attempt_p90":0.80},
    {"indoor_outdoor":"outdoor","score_bin":"close","time_bin":"late","ytg_bin":"med","distance":65,"prob_attempt_mean":0.35,"prob_attempt_p10":0.20,"prob_attempt_p90":0.55}
  ]
}</script>
<script id="demo_sens" type="application/json">{"A":0.0,"B":0.55,"C":0.45}</script>

<script>
let GRID=null, KICKERS=[], ATTEMPT=null, SENS=null;
let gridIndex=new Map(), attemptIndex=new Map(), KMAP=new Map();
let temps=[], winds=[];

const $ = sel => document.querySelector(sel);
const distance  = $('#distance');
const uiDist    = $('#uiDist');
const envSel    = $('#env');
const tempInp   = $('#temp');
const windInp   = $('#wind');
const kickerSel = $('#kicker');
const kickerSearch = $('#kickerSearch');
const bandSel   = $('#band');
const scoreBin  = $('#scoreBin');
const timeBin   = $('#timeBin');
const ytgBin    = $('#ytgBin');
const loadMsgEl = $('#loadMsg');
const kmetaEl   = $('#kmeta');
const chartEl   = $('#chart');
const toggleAxes= $('#toggleAxes');
const toggleAttempt = $('#toggleAttempt');
const btnCSV    = $('#btnCSV');
const btnPNG    = $('#btnPNG');
const btnReset  = $('#btnReset');
const btnShare  = $('#btnShare');
const toastEl   = $('#toast');

const statMake=$('#statMake'), statMakeCI=$('#statMakeCI');
const statAttemptBase=$('#statAttemptBase'), statAttemptBaseCI=$('#statAttemptBaseCI');
const statAttemptAdj=$('#statAttemptAdj'), statOverall=$('#statOverall');
const detailsEl=$('#details');

const upWrap       = $('#fallbackUpload');
const fileGrid     = $('#fileGrid');
const fileKickers  = $('#fileKickers');
const fileAttempt  = $('#fileAttempt');
const fileSens     = $('#fileSens');
const btnUseUploads= $('#btnUseUploads');

function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
function logit(p){ p = Math.min(Math.max(p,1e-9), 1-1e-9); return Math.log(p/(1-p)); }
function sigmoid(x){ return 1/(1+Math.exp(-x)); }
function pct(x,dp=1){ return (x*100).toFixed(dp) + "%"; }

function showToast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 1200); }

function onEnvChange(){ if (envSel.value === 'indoor'){ windInp.value = 0; windInp.disabled = true; } else { windInp.disabled = false; } recompute(); }

function buildMakeIndex(){ gridIndex.clear(); temps = GRID.meta.temps.slice(); winds = GRID.meta.winds.slice(); for(const r of GRID.grid){ gridIndex.set(`${r.indoor_outdoor}|${r.temp_F}|${r.wind_mph}|${r.distance}`, r); } }
function buildAttemptIndex(){ attemptIndex.clear(); for(const r of ATTEMPT.grid){ attemptIndex.set(`${r.indoor_outdoor}|${r.score_bin}|${r.time_bin}|${r.ytg_bin}|${r.distance}`, r); } }
function populateKickers(){ KMAP.clear(); kickerSel.innerHTML = `<option value="">— none —</option>`; const frag = document.createDocumentFragment(); const sorted = [...KICKERS].sort((a,b)=> (b.attempts_eff||0) - (a.attempts_eff||0)); for(const k of sorted){ const opt = document.createElement('option'); opt.value = k.kicker_id; opt.textContent = `${k.kicker_name || k.kicker_id} (effAtt=${(k.attempts_eff||0).toFixed(1)})`; frag.appendChild(opt); KMAP.set(k.kicker_id, k); } kickerSel.appendChild(frag); }

function neighbors(val, arr){ if (arr.length===0) return [val,val]; if (val <= arr[0]) return [arr[0], arr[0]]; if (val >= arr[arr.length-1]) return [arr[arr.length-1], arr[arr.length-1]]; for (let i=0; i<arr.length-1; i++){ if (val >= arr[i] && val <= arr[i+1]) return [arr[i], arr[i+1]]; } return [arr[0], arr[0]]; }
function nearest(val, arr){ if(!arr || arr.length===0) return val; let best = arr[0], bd = Math.abs(val-arr[0]); for(const x of arr){ const d = Math.abs(val-x); if (d<bd){ bd=d; best=x; } } return best; }
function lookupMake(env, temp, wind, dist){ return gridIndex.get(`${env}|${temp}|${wind}|${dist}`) || null; }
function interpBilinearLogit(env, temp, wind, dist){ if (env === 'indoor') wind = 0; const [t0,t1]=neighbors(temp, temps), [w0,w1]=neighbors(wind, winds); const sameT=(t0===t1), sameW=(w0===w1); const r00=lookupMake(env,t0,w0,dist), r10=lookupMake(env,t1,w0,dist), r01=lookupMake(env,t0,w1,dist), r11=lookupMake(env,t1,w1,dist); if (!r00 || (!sameT && !r10) || (!sameW && !r01) || (!sameT && !sameW && !r11)){ const tN=nearest(temp,temps), wN=(env==='indoor'?0:nearest(wind,winds)); const r=lookupMake(env,tN,wN,dist); if (!r) return null; return {mean:r.prob_mean, lo:r.prob_p10, hi:r.prob_p90, baseMean:r.prob_mean, mode:"nearest"}; } function blend(field){ const L00=logit(r00[field]), L10=sameT?L00:logit(r10[field]); const L01=sameW?L00:logit(r01[field]), L11=(sameT&&sameW)?L00:logit(r11[field]); const wt=sameT?0:(temp-t0)/(t1-t0), ww=sameW?0:(wind-w0)/(w1-w0); const L0=L00*(1-wt)+L10*wt, L1=L01*(1-wt)+L11*wt; return sigmoid(L0*(1-ww)+L1*ww); } return {mean:blend("prob_mean"), lo:blend("prob_p10"), hi:blend("prob_p90"), baseMean:blend("prob_mean"), mode:"bilinear"}; }

// kicker band blending
const BAND_BOUNDS = { short:39, mid:49, long:59 };
const BLEND_W = 2;
function bandWeightsForDistance(d){ if (d <= BAND_BOUNDS.short - BLEND_W) return {short:1}; if (d <  BAND_BOUNDS.short + BLEND_W){ const t=(d-(BAND_BOUNDS.short-BLEND_W))/(2*BLEND_W); return {short:1-t, mid:t}; } if (d <= BAND_BOUNDS.mid - BLEND_W) return {mid:1}; if (d <  BAND_BOUNDS.mid + BLEND_W){ const t=(d-(BAND_BOUNDS.mid-BLEND_W))/(2*BLEND_W); return {mid:1-t, long:t}; } if (d <= BAND_BOUNDS.long - BLEND_W) return {long:1}; if (d <  BAND_BOUNDS.long + BLEND_W){ const t=(d-(BAND_BOUNDS.long-BLEND_W))/(2*BLEND_W); return {long:1-t, xlong:t}; } return {xlong:1}; }
function kickerShiftForDistance(krec, d){ if (!krec || !krec.bands) return {delta:0, se:0}; const w=bandWeightsForDistance(d); let delta=0, var_sum=0, wsum=0; for (const band of Object.keys(w)){ const ww=w[band], b=krec.bands[band]; if (!b) continue; const dlt=(typeof b.delta_logit==="number")?b.delta_logit:0; const se=(typeof b.se==="number")?b.se:0; delta += ww*dlt; var_sum += (ww*ww)*(se*se); wsum += ww; } if (wsum<=0) return {delta:0,se:0}; return {delta, se:Math.sqrt(var_sum)}; }

function ciScale(band){ if (band===80) return 1.0; if (band===68) return 0.68/0.80; if (band===90) return 0.90/0.80; return 1.0; }
function lookupAttempt(env, sBin, tBin, yBin, dist){ return attemptIndex.get(`${env}|${sBin}|${tBin}|${yBin}|${dist}`) || null; }

function stateFromControls(){ return { d:clamp(parseInt(distance.value,10)||61,18,68), env:envSel.value, t:parseFloat(tempInp.value)||65, w:parseFloat(windInp.value)||0, kid:kickerSel.value||'', band:parseInt(bandSel.value,10)||80, s:scoreBin.value, tm:timeBin.value, y:ytgBin.value, showAttempt: toggleAttempt.checked, axes: toggleAxes.checked }; }
function controlsFromState(s){ distance.value=s.d; uiDist.value=s.d; envSel.value=s.env; tempInp.value=s.t; windInp.value=s.w; kickerSel.value=s.kid||''; bandSel.value=s.band; scoreBin.value=s.s; timeBin.value=s.tm; ytgBin.value=s.y; toggleAttempt.checked = !!s.showAttempt; toggleAxes.checked = !!s.axes; onEnvChange(); }
function encodeState(s){ const p=new URLSearchParams(s); return p.toString(); }
function decodeState(qs){ const p=new URLSearchParams(qs); const num=(k,def)=>{const v=parseFloat(p.get(k)); return Number.isFinite(v)?v:def}; const int=(k,def)=>{const v=parseInt(p.get(k),10); return Number.isFinite(v)?v:def}; return { d:int('d',61), env:p.get('env')||'outdoor', t:num('t',65), w:num('w',5), kid:p.get('kid')||'', band:int('band',80), s:p.get('s')||'close', tm:p.get('tm')||'late', y:p.get('y')||'med', showAttempt: p.get('showAttempt')!=='false', axes: p.get('axes')!=='false' }; }

function recompute(){ if (!GRID || !ATTEMPT || !SENS) return; const st = stateFromControls(); uiDist.value = st.d; // Base league make (no kicker)
  const base = interpBilinearLogit(st.env, st.t, st.w, st.d); if (!base){ statMake.textContent='No data'; statMakeCI.textContent=''; detailsEl.textContent=''; kmetaEl.textContent=''; drawChart(st.env,st.t,st.w,st.d,st); return; }
  let pMakeLeague = base.baseMean; // before kicker
  let pMean = base.mean, pLo = base.lo, pHi = base.hi;
  // Kicker adjust in logit space
  const kid = st.kid; let kmeta = ""; if (kid){ const krec = KMAP.get(kid); const ks = kickerShiftForDistance(krec, st.d); const delta = ks.delta, se = ks.se||0; pMean = sigmoid(logit(pMean) + delta); pLo = sigmoid(logit(pLo) + delta - se); pHi = sigmoid(logit(pHi) + delta + se); const bands = Object.keys(krec?.bands||{}).join(', '); kmeta = `Kicker: ${krec?.kicker_name || kid} · effAtt=${(krec?.attempts_eff||0).toFixed(1)} · bands=[${bands}] · Δlogit(d)=${delta.toFixed(3)}`; }
  kmetaEl.textContent = kmeta;
  // Rescale CI to selected band
  const lmean = logit(pMean), scale = ciScale(st.band); let llo = logit(pLo), lhi = logit(pHi), half=(lhi-llo)/2; llo = lmean - half*scale; lhi = lmean + half*scale; pLo = sigmoid(llo); pHi = sigmoid(lhi);
  // Attempt base (league context)
  const rA = lookupAttempt(st.env, st.s, st.tm, st.y, st.d); const pAttemptBase = rA ? rA.prob_attempt_mean : 0.0; const pAttemptBase_lo = rA ? rA.prob_attempt_p10 : 0.0; const pAttemptBase_hi = rA ? rA.prob_attempt_p90 : 0.0;
  // Attempt adjusted by kicker advantage (coupling)
  const A=SENS.A, B=SENS.B, C=SENS.C; const lA = A + C*logit(pAttemptBase) + B*(logit(pMean) - logit(pMakeLeague)); const pAttemptAdj = sigmoid(lA);
  // Overall chance to get 3 points
  const pOverall = pAttemptAdj * pMean;
  // Headline stats
  statMake.textContent = pct(pMean); statMakeCI.textContent = `(CI ${st.band}%: ${pct(pLo)}–${pct(pHi)})`; statAttemptBase.textContent = pct(pAttemptBase); statAttemptBaseCI.textContent = `(p10–p90: ${pct(pAttemptBase_lo)}–${pct(pAttemptBase_hi)})`; statAttemptAdj.textContent = pct(pAttemptAdj); statOverall.textContent = pct(pOverall);
  const wShow = st.env==='indoor'?0:st.w; detailsEl.textContent = `Inputs: ${st.d} yd, ${st.env}, ${Math.round(st.t)}°F, wind ${Math.round(wShow)} mph · Score=${st.s}, Time=${st.tm}, YTG=${st.y} · ${base.mode}`;
  drawChart(st.env, st.t, st.w, st.d, st);
  // update URL (debounced)
  if (history.replaceState){ const s = encodeState(st); history.replaceState(null,'',`?${s}`); }
}
const recomputeDebounced = (()=>{ let t=null; return ()=>{ clearTimeout(t); t=setTimeout(recompute, 30); }; })();

function drawChart(env, temp, wind, dSel, st){ const W=880,H=280,PAD=38; const xs=[], meanYs=[], loYs=[], hiYs=[], attYs=[]; for(let d=18; d<=68; d++){ const r = interpBilinearLogit(env, temp, wind, d); if(!r) continue; xs.push(d); meanYs.push(r.mean); loYs.push(r.lo); hiYs.push(r.hi); const kid = st.kid; if (kid){ const krec = KMAP.get(kid); const ks = kickerShiftForDistance(krec, d); meanYs[meanYs.length-1] = sigmoid(logit(meanYs[meanYs.length-1]) + ks.delta); loYs[loYs.length-1] = sigmoid(logit(loYs[loYs.length-1]) + ks.delta - (ks.se||0)); hiYs[hiYs.length-1] = sigmoid(logit(hiYs[hiYs.length-1]) + ks.delta + (ks.se||0)); }
    if (st.showAttempt){ const rA = lookupAttempt(env, st.s, st.tm, st.y, d); attYs.push(rA ? rA.prob_attempt_mean : 0); } }
  const xmin=18,xmax=68,ymin=0,ymax=1; const sx=x=>PAD+(x-xmin)/(xmax-xmin)*(W-2*PAD); const sy=y=>H-PAD-(y-ymin)/(ymax-ymin)*(H-2*PAD); const path=(xs,ys)=>xs.map((x,i)=>`${i?'L':'M'} ${sx(x).toFixed(1)} ${sy(ys[i]).toFixed(1)}`).join(' ');
  const meanPath=path(xs,meanYs), loPath=path(xs,loYs), hiPath=path(xs,hiYs); const bandPath = meanYs.length?(()=>{ const up=xs.map((x,i)=>`${i?'L':'M'} ${sx(x).toFixed(1)} ${sy(hiYs[i]).toFixed(1)}`).join(' '); const dn=xs.slice().reverse().map((x,i)=>`L ${sx(x).toFixed(1)} ${sy(loYs[loYs.length-1-i]).toFixed(1)}`).join(' '); return `${up} ${dn} Z`; })() : ""; const xd = sx(dSel);
  const ticksX=[20,30,40,50,60,68]; const ticksY=[0.2,0.4,0.6,0.8,1.0];
  let attemptPath = '';
  if (st.showAttempt && attYs.length===xs.length){ attemptPath = path(xs,attYs); }
  const showAxes = toggleAxes.checked;
  chartEl.innerHTML = `
    <rect x="0" y="0" width="${W}" height="${H}" fill="#0f141b"/>
    <g stroke="${showAxes? '#1f2a38':'transparent'}" stroke-width="1" opacity="0.9">
      ${ticksY.map(p=>`<line x1="${PAD}" x2="${W-PAD}" y1="${sy(p)}" y2="${sy(p)}"></line>`).join('')}
      ${ticksX.map(x=>`<line x1="${sx(x)}" x2="${sx(x)}" y1="${PAD}" y2="${H-PAD}"></line>`).join('')}
    </g>
    ${showAxes? `<g fill="#a6c1da" font-size="10">
      ${ticksY.map(p=>`<text x="${PAD-8}" y="${sy(p)+3}" text-anchor="end">${Math.round(p*100)}</text>`).join('')}
      ${ticksX.map(x=>`<text x="${sx(x)}" y="${H-PAD+14}" text-anchor="middle">${x}</text>`).join('')}
      <text x="${W/2}" y="${H-4}" text-anchor="middle">Distance (yd)</text>
      <text transform="translate(12 ${H/2}) rotate(-90)" text-anchor="middle">Probability (%)</text>
    </g>` : ''}
    <path d="${bandPath}" fill="#3da9fc22" stroke="none"></path>
    <path d="${meanPath}" fill="none" stroke="#3da9fc" stroke-width="2"></path>
    <path d="${loPath}"   fill="none" stroke="#3da9fc55" stroke-width="1"></path>
    <path d="${hiPath}"   fill="none" stroke="#3da9fc55" stroke-width="1"></path>
    ${attemptPath? `<path d="${attemptPath}" fill="none" stroke="#7ae582" stroke-dasharray="5 4" stroke-width="1.6"></path>`: ''}
    <line x1="${xd}" x2="${xd}" y1="${PAD}" y2="${H-PAD}" stroke="#ffcc66" stroke-width="2" stroke-dasharray="4 4"></line>`;
}

function csvDownload(){ const st=stateFromControls(); let rows=[["distance","make_mean","make_lo","make_hi","attempt_mean","attempt_lo","attempt_hi"]]; for(let d=18; d<=68; d++){ const base = interpBilinearLogit(st.env, st.t, st.w, d); if (!base) continue; let m=base.mean, lo=base.lo, hi=base.hi; if (st.kid){ const krec=KMAP.get(st.kid); const ks=kickerShiftForDistance(krec,d); m=sigmoid(logit(m)+ks.delta); lo=sigmoid(logit(lo)+ks.delta-(ks.se||0)); hi=sigmoid(logit(hi)+ks.delta+(ks.se||0)); }
  const rA = lookupAttempt(st.env, st.s, st.tm, st.y, d); const a=rA? rA.prob_attempt_mean:0, alo=rA? rA.prob_attempt_p10:0, ahi=rA? rA.prob_attempt_p90:0; rows.push([d,m,lo,hi,a,alo,ahi]); }
  const csv = rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fg_profile.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); }

function pngDownload(){ // convert SVG to PNG
  const svg = chartEl; const xml = new XMLSerializer().serializeToString(svg); const svg64 = 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(xml); const img = new Image(); img.onload = function(){ const W=svg.viewBox.baseVal.width || svg.clientWidth, H=svg.viewBox.baseVal.height || svg.clientHeight; const c=document.createElement('canvas'); c.width=W; c.height=H; const ctx=c.getContext('2d'); ctx.fillStyle='#0f141b'; ctx.fillRect(0,0,W,H); ctx.drawImage(img,0,0); c.toBlob(b=>{ const url=URL.createObjectURL(b); const a=document.createElement('a'); a.href=url; a.download='fg_profile.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); },'image/png'); }; img.src=svg64; }

function tryFetch(url){ return fetch(url).then(r=>{ if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }); }
function readFileAsJSON(input){ return new Promise((res,rej)=>{ if(!input.files||!input.files[0]) return rej(new Error("No file")); const fr=new FileReader(); fr.onload=()=>{ try{res(JSON.parse(fr.result))}catch(e){rej(e)} }; fr.onerror=()=>rej(fr.error); fr.readAsText(input.files[0]); }); }

async function boot(){ // try to fetch colocated JSONs
  try{
    loadMsgEl.textContent = "Loading JSONs via fetch…";
    GRID    = await tryFetch('./fg_prob_grid_distance_env_temp_wind.json');
    KICKERS = await tryFetch('./kicker_deltas_logit_banded.json');
    ATTEMPT = await tryFetch('./fg_attempt_grid_distance_env_context.json');
    SENS    = await tryFetch('./attempt_sensitivity.json');
    loadMsgEl.textContent = "Loaded via fetch.";
    afterLoad();
  }catch(e){
    console.warn('Fetch failed, using demo or uploads', e);
    // Attempt embedded demo data
    try{
      GRID = JSON.parse(document.getElementById('demo_grid').textContent);
      KICKERS = JSON.parse(document.getElementById('demo_kickers').textContent);
      ATTEMPT = JSON.parse(document.getElementById('demo_attempt').textContent);
      SENS = JSON.parse(document.getElementById('demo_sens').textContent);
      loadMsgEl.innerHTML = `<span class="warn">Demo data loaded. Upload real JSONs or host alongside this file.</span>`;
      document.getElementById('fallbackUpload').style.display = "flex";
      afterLoad();
    }catch(err){
      loadMsgEl.innerHTML = `<span class="warn">No data. Upload the four JSONs below or run a local server.</span>`;
      document.getElementById('fallbackUpload').style.display = "flex";
    }
    btnUseUploads.onclick = async ()=>{
      try{
        GRID    = await readFileAsJSON(fileGrid);
        KICKERS = await readFileAsJSON(fileKickers);
        ATTEMPT = await readFileAsJSON(fileAttempt);
        SENS    = await readFileAsJSON(fileSens);
        loadMsgEl.textContent = "Loaded via file uploads.";
        document.getElementById('fallbackUpload').style.display = "none";
        afterLoad();
      }catch(err){
        loadMsgEl.innerHTML = `<span class="warn">Upload parse error: ${err.message}</span>`;
      }
    };
  }
}

function afterLoad(){ buildMakeIndex(); buildAttemptIndex(); populateKickers(); kickerSearch.value=''; filterKickers(''); attachEvents(); // from URL if present
  const st = decodeState(location.search.slice(1)); controlsFromState(st); recompute(); }

function filterKickers(q){ const opts=[...kickerSel.options]; const term=(q||'').toLowerCase(); opts.forEach((o,i)=>{ if(i===0) return; const t=o.textContent.toLowerCase(); o.hidden = !(t.includes(term)); }); }

function attachEvents(){ distance.addEventListener('input', ()=>{uiDist.value=distance.value; recomputeDebounced();}); uiDist.addEventListener('input', ()=>{distance.value=clamp(parseInt(uiDist.value,10)||61,18,68); recomputeDebounced();}); envSel.addEventListener('change', onEnvChange); tempInp.addEventListener('input', recomputeDebounced); windInp.addEventListener('input', recomputeDebounced); kickerSel.addEventListener('change', recomputeDebounced); bandSel.addEventListener('change', recomputeDebounced); scoreBin.addEventListener('change', recomputeDebounced); timeBin.addEventListener('change', recomputeDebounced); ytgBin.addEventListener('change', recomputeDebounced); toggleAttempt.addEventListener('change', recomputeDebounced); toggleAxes.addEventListener('change', recomputeDebounced);
  document.querySelectorAll('[data-preset-temp]').forEach(b=> b.addEventListener('click',()=>{ tempInp.value=b.getAttribute('data-preset-temp'); recompute(); })); document.querySelectorAll('[data-preset-wind]').forEach(b=> b.addEventListener('click',()=>{ windInp.value=b.getAttribute('data-preset-wind'); recompute(); }));
  kickerSearch.addEventListener('input', (e)=> filterKickers(e.target.value));
  btnCSV.addEventListener('click', ()=>{ csvDownload(); showToast('CSV downloaded'); }); btnPNG.addEventListener('click', ()=>{ pngDownload(); showToast('PNG downloaded'); });
  btnReset.addEventListener('click', ()=>{ const def={d:61,env:'outdoor',t:65,w:5,kid:'',band:80,s:'close',tm:'late',y:'med', showAttempt:true, axes:true}; controlsFromState(def); recompute(); showToast('Reset'); });
  btnShare.addEventListener('click', ()=>{ const s=encodeState(stateFromControls()); navigator.clipboard?.writeText(location.origin+location.pathname+`?${s}`); showToast('Permalink copied'); });
  // keyboard nudges for distance
  uiDist.addEventListener('keydown', (e)=>{ if(e.key==='ArrowUp'||e.key==='ArrowDown'){ e.preventDefault(); const delta = (e.key==='ArrowUp'? 1 : -1); const v=clamp(parseInt(uiDist.value,10)||61,18,68)+delta; uiDist.value=v; distance.value=v; recomputeDebounced(); }});
  // Copy chart to clipboard (PNG) via keyboard
  chartEl.addEventListener('keydown', (e)=>{ const meta = e.ctrlKey||e.metaKey; if(meta && e.key.toLowerCase()==='c'){ e.preventDefault(); pngDownload(); }});
}

boot();
</script>
</body>
</html>
